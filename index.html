<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tango Events Around Durango — Durangotango.info</title>
<link rel="stylesheet" href="./assets/styles.css">
</head>
<body>
<header>
  <div class="title">Tango Events Around Durango</div>
  <div class="controls">
    <a class="btn" href="./assets/Tango%20Local.ics" download>Subscribe Local</a>
    <a class="btn" href="./assets/Tango%20Regional.ics" download>Subscribe Regional</a>
  </div>
</header>
<div class="controls" id="viewControls" style="margin:8px">
  <button class="btn active" data-view="month">Month</button>
  <button class="btn" data-view="agenda">Agenda</button>
  <span style="width:12px"></span>
  <button class="btn active" data-filter="all">All</button>
  <button class="btn" data-filter="local">Local</button>
  <button class="btn" data-filter="regional">Regional</button>
</div>
<div class="legend">
  <span class="dot local"></span> Local
  <span class="dot regional"></span> Regional
</div>
<div id="monthView" style="display:block">
  <div class="month" id="monthHeaders"></div>
  <div class="month" id="monthGrid"></div>
</div>
<div id="agendaView" style="display:none">
  <div class="list" id="agendaList"></div>
</div>
<footer>© 2025 durangotango.info — Data from Local + Regional ICS feeds</footer>
<script>
function parseICS(text, tag){
  const lines=text.split(/\r?\n/);const evs=[];let cur=null;let inEvent=false;
  function dt(line){const m=line.match(/:(\d{8})T(\d{6})/);if(!m)return null;
    return new Date(+m[1].slice(0,4),+m[1].slice(4,6)-1,+m[1].slice(6,8),+m[2].slice(0,2),+m[2].slice(2,4));}
  for(const l of lines){
    if(l==='BEGIN:VEVENT'){inEvent=true;cur={};continue;}
    if(l==='END:VEVENT'){if(cur&&cur.dtstart){cur.tag=tag;evs.push(cur);}inEvent=false;continue;}
    if(!inEvent)continue;
    if(l.startsWith('DTSTART'))cur.dtstart=dt(l);
    if(l.startsWith('DTEND'))cur.dtend=dt(l);
    if(l.startsWith('SUMMARY:'))cur.summary=l.slice(8);
    if(l.startsWith('LOCATION:'))cur.location=l.slice(9);
  }
  return evs;
}
async function loadAll(){
  const [a,b]=await Promise.all([fetch('./assets/Tango%20Local.ics').then(r=>r.text()),fetch('./assets/Tango%20Regional.ics').then(r=>r.text())]);
  let evs=[...parseICS(a,'local'),...parseICS(b,'regional')];
  evs.sort((x,y)=>x.dtstart-y.dtstart);window.events=evs;render();
}
let state={view:'month',filter:'all'};
function sameDay(a,b){return a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()&&a.getDate()==b.getDate();}
function fmt(d){return d.toLocaleString([], {month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});}
function filtered(){return state.filter==='all'?window.events:window.events.filter(e=>e.tag===state.filter);}
function renderMonth(){const h=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
document.getElementById('monthHeaders').innerHTML=h.map(x=>`<div class='day-header'>${x}</div>`).join('');
const grid=document.getElementById('monthGrid');grid.innerHTML='';
const base=new Date();base.setDate(1);
const days=new Date(base.getFullYear(),base.getMonth()+1,0).getDate();
const offset=new Date(base.getFullYear(),base.getMonth(),1).getDay();
const cells=[];for(let i=0;i<offset;i++)cells.push(null);for(let d=1;d<=days;d++)cells.push(new Date(base.getFullYear(),base.getMonth(),d));
while(cells.length%7)cells.push(null);
for(const c of cells){const div=document.createElement('div');div.className='cell';
if(!c){div.style.visibility='hidden';grid.appendChild(div);continue;}
div.innerHTML=`<div class='dnum'>${c.getDate()}</div>`;
for(const e of filtered().filter(e=>sameDay(e.dtstart,c))){div.innerHTML+=`<div class='ev'>${e.summary}</div>`;}
grid.appendChild(div);}}
function renderAgenda(){const list=document.getElementById('agendaList');list.innerHTML='';
for(const e of filtered()){list.innerHTML+=`<div class='item'><div>${fmt(e.dtstart)} — ${e.summary}${e.location?' · '+e.location:''}</div></div>`;}}
function render(){if(!window.events)return;if(state.view==='month'){renderMonth();document.getElementById('monthView').style.display='block';document.getElementById('agendaView').style.display='none';}else{renderAgenda();document.getElementById('monthView').style.display='none';document.getElementById('agendaView').style.display='block';}}
document.getElementById('viewControls').addEventListener('click',e=>{const b=e.target.closest('button');if(!b)return;
if(b.dataset.view){state.view=b.dataset.view;document.querySelectorAll('[data-view]').forEach(x=>x.classList.remove('active'));b.classList.add('active');render();}
if(b.dataset.filter){state.filter=b.dataset.filter;document.querySelectorAll('[data-filter]').forEach(x=>x.classList.remove('active'));b.classList.add('active');render();}});
loadAll();
</script>
</body></html>