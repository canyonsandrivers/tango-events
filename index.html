<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tango Events Around Durango â€” Durango Tango</title>
  <link rel="canonical" href="https://durangotango.info/">

  <meta name="description" content="Find upcoming Argentine Tango events in and around Durango, Colorado â€” practicas, milongas, workshops, and festivals updated regularly.">
  <meta name="robots" content="index, follow">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://durangotango.info/">
  <meta property="og:title" content="Tango Events Around Durango â€” Durango Tango">
  <meta property="og:description" content="Find upcoming Argentine Tango events in and around Durango, Colorado â€” practicas, milongas, workshops, and festivals updated regularly.">
  <meta property="og:image" content="https://durangotango.info/assets/tango-preview.jpg">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Tango Events Around Durango â€” Durango Tango">
  <meta name="twitter:description" content="Find upcoming Argentine Tango events in and around Durango, Colorado â€” practicas, milongas, workshops, and festivals updated regularly.">
  <meta name="twitter:image" content="https://durangotango.info/assets/tango-preview.jpg">

  <link rel="icon" href="/assets/favicon.ico">

  <!-- Organization & Website structured data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Durango Tango",
    "url": "https://durangotango.info",
    "logo": "https://durangotango.info/assets/tango-preview.jpg"
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Durango Tango â€” Events",
    "url": "https://durangotango.info"
  }
  </script>

  <style>
    :root{
      --bg:#0b1020; --card:#0f172a; --muted:#9ca3af; --fg:#e5e7eb;
      --border:#1f2937; --accent:#38bdf8; --local:#10b981; --regional:#fb923c; --other:#f43f5e;
      --chip-bg:#131a2b; --chip-br:#263044;
    }
    *{ box-sizing:border-box; }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial; }
    a{ color:inherit; text-decoration:none; }

    .wrap{ max-width:1100px; margin:0 auto; padding: clamp(12px,2vw,24px); }
    header{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .title{ font-weight:800; letter-spacing:.2px; font-size:clamp(1.25rem, 1rem + 1.2vw, 1.8rem); margin-right:auto; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-left:auto; }
    .btn{ background:#111827; border:1px solid var(--border); color:var(--fg); padding:8px 12px; border-radius:10px; display:inline-flex; gap:8px; align-items:center; cursor:pointer; }
    .btn:hover{ background:#162034; }
    .btn.primary{ border-color:var(--accent); box-shadow: 0 0 0 1px color-mix(in oklab, var(--accent) 40%, transparent); }

    .toolbar{ display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .toolbar .spacer{ flex: 1 1 auto; }
    .month{ font-weight:600; color:#d1d5db; }
    .navbtn{ background:#111827; border:1px solid var(--border); color:#fff; width:36px; height:36px; border-radius:10px; font-size:18px; line-height:1; cursor:pointer; }
    .navbtn:hover{ background:#162034; }

    .legend{ display:flex; gap:16px; align-items:center; font-size:.9rem; color:#cbd5e1; flex-wrap:wrap; }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px; }
    .dot.local{ background: var(--local); }
    .dot.regional{ background: var(--regional); }

    .filters{ display:flex; gap:8px; align-items:center; }
    .pill{ border:1px solid var(--border); background:#101827; color:#d1d5db; padding:6px 10px; border-radius:999px; cursor:pointer; font-size:.85rem; }
    .pill.active{ border-color: var(--accent); color:#f3f4f6; }

    .weekdays{ display:grid; grid-template-columns: repeat(7,1fr); gap:10px; margin-top:12px; }
    .weekdays div{ text-align:center; font-size:.82rem; color:#a3a3a3; padding:6px 0; }

    .grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:10px; margin-top:10px; }
    .cell{
      min-height:140px; background:var(--card); border:1px solid var(--border); border-radius:14px;
      padding:10px 10px 12px; position:relative; overflow:hidden;
      padding-top: 34px; display:flex; flex-direction:column;
    }
    .day{
      position:absolute; top:8px; left:10px; color:#cbd5e1; font-size:.8rem;
      background:rgba(203,213,225,.08); border:1px solid rgba(203,213,225,.25);
      padding:2px 8px; border-radius:999px; backdrop-filter: blur(2px);
    }
    .count{ position:absolute; top:8px; right:10px; font-size:.7rem; color:#9ca3af; }

    .events{ display:flex; flex-direction:column; gap:8px; margin-top: 2px; }
    .evt{
      display:block; padding:.55rem .65rem; border-radius:12px; font-size:.85rem; line-height:1.2rem;
      background: var(--chip-bg); border:1px solid var(--chip-br); color:#f9fafb;
      box-shadow: 0 4px 10px rgba(0,0,0,.22);
      transition: transform .08s ease, box-shadow .12s ease, filter .12s ease;
    }
    .evt:hover{ transform: translateY(-1px); filter: brightness(1.03); box-shadow: 0 6px 12px rgba(0,0,0,.28); }
    .evt.local{ background: color-mix(in oklab, var(--local) 16%, black); border-color: color-mix(in oklab, var(--local) 65%, var(--chip-br)); }
    .evt.regional{ background: color-mix(in oklab, var(--regional) 16%, black); border-color: color-mix(in oklab, var(--regional) 65%, var(--chip-br)); }

    .evt .t{ font-weight:700; display:block; }
    .evt .loc{ color:#d1d5db; display:inline; }
    .evt .tm{ color:#c5c9d2; font-variant-numeric: tabular-nums; margin-left:6px; }

    .notice{ background:#3b0a0a; color:#fecaca; border:1px solid #7f1d1d; padding:10px 12px; border-radius:10px; margin-top:12px; display:none; }
    .notice.show{ display:block; }

    @media (max-width: 960px){
      .grid{ grid-template-columns: repeat(3,1fr); }
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: repeat(1,1fr); }
      .weekdays{ display:none; }
      .cell{ min-height: auto; }
    }

    .viewtabs{ display:flex; gap:8px; margin-right:8px; }
    .agenda{ margin-top:14px; }
    .agenda .daygroup{ background:var(--card); border:1px solid var(--border); border-radius:14px; margin-bottom:10px; overflow:hidden; }
    .agenda .dayhead{ padding:10px 12px; font-weight:600; color:#e5e7eb; background:#0f1a33; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; }
    .agenda .items{ padding:10px 12px; display:flex; flex-direction:column; gap:8px; }
    .agenda .it{ display:flex; gap:10px; align-items:flex-start; }
    .agenda .it .dot{ width:10px; height:10px; border-radius:999px; margin-top:6px; }
    .agenda .it .dot.local{ background:var(--local); }
    .agenda .it .dot.regional{ background:var(--regional); }
    .agenda .it .info{ flex:1; }
    .agenda .it .t{ font-weight:700; }
    .agenda .it .meta{ color:#cbd5e1; font-size:.9rem; }
    @media (max-width: 720px){
      .viewtabs{ order:3; width:100%; }
    }

    footer{ margin-top: 18px; color:#cbd5e1; font-size:.95rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Tango Events Around Durango</div>
      <div class="actions">
        <button class="btn primary" id="subscribeCombined">ðŸ“¥ Subscribe (.ics)</button>
      </div>
    </header>

    <div class="toolbar">
      <div class="viewtabs">
        <button class="pill view active" data-view="month">Month</button>
        <button class="pill view" data-view="agenda">Agenda</button>
      </div>
      <button id="prevMonth" class="navbtn" aria-label="Previous Month">â€¹</button>
      <div id="monthLabel" class="month">Loadingâ€¦</div>
      <button id="nextMonth" class="navbtn" aria-label="Next Month">â€º</button>

      <div class="spacer"></div>

      <div class="legend">
        <div><span class="dot local"></span>Local</div>
        <div><span class="dot regional"></span>Regional</div>
      </div>

      <div class="filters">
        <button class="pill active" data-filter="all">All</button>
        <button class="pill" data-filter="local">Local</button>
        <button class="pill" data-filter="regional">Regional</button>
      </div>
    </div>

    <div id="notice" class="notice"></div>

    <div class="weekdays">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div id="grid" class="grid" aria-live="polite" aria-busy="true"></div>
    <div id="agenda" class="agenda" style="display:none;"></div>

    <footer>
      Find upcoming Argentine Tango events in and around Durango, Colorado â€” practicas, milongas, workshops, and festivals updated regularly.
    </footer>
  </div>

  <script>
  // ---------- DOM refs & state ----------
  const grid = document.getElementById('grid');
  const monthLabel = document.getElementById('monthLabel');
  const notice = document.getElementById('notice');

  let current = new Date(); current.setDate(1);
  let RAW = [];  // parsed events
  let FILTER = 'all';
  let RAW_BLOCKS = []; // raw VEVENT blocks from all calendars for combined .ics download

  const DOW = ['SU','MO','TU','WE','TH','FR','SA'];
  const DOW_IDX = { SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6 };

  // ---------- utils ----------
  function ymd(d){ const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+"-"+z(d.getMonth()+1)+"-"+z(d.getDate()); }
  function dFromYMDLocal(s){ const m=s.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/); if(!m) return new Date(s); return new Date(+m[1], +m[2]-1, +m[3]); }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function within(d, a, b){ return d>=a && d<=b; }
  function toUTCYYYYMMDDTHHMMSS(d){ const z=n=>String(n).padStart(2,'0'); return d.getUTCFullYear()+z(d.getUTCMonth()+1)+z(d.getUTCDate())+"T"+z(d.getUTCHours())+z(d.getUTCMinutes())+z(d.getUTCSeconds())+"Z"; }
  function formatTime12(hhmm){ if (!hhmm) return ""; const [h,m] = hhmm.split(':').map(Number); const hour=(h%12)||12; return `${hour}:${pad2(m)} ${h<12?'AM':'PM'}`; }

  function nthDowOfMonth(year, month, n, dow){
    if (n>0){
      const first=new Date(year, month, 1);
      const delta=(dow-first.getDay()+7)%7;
      const date=1+delta+7*(n-1);
      const d=new Date(year, month, date);
      return d.getMonth()===month?d:null;
    } else {
      const last=new Date(year, month+1, 0);
      const delta=(last.getDay()-dow+7)%7;
      const date=last.getDate()-delta+7*(n+1);
      const d=new Date(year, month, date);
      return d.getMonth()===month?d:null;
    }
  }
  function isDSTDenver(d){
    const y=d.getFullYear();
    const dstStart=nthDowOfMonth(y,2,2,0); // Mar 2nd Sun
    const dstEnd=nthDowOfMonth(y,10,1,0);  // Nov 1st Sun
    if(!dstStart||!dstEnd) return false;
    return d>=new Date(dstStart.getFullYear(),dstStart.getMonth(),dstStart.getDate(),2,0,0) &&
           d< new Date(dstEnd.getFullYear(),dstEnd.getMonth(),dstEnd.getDate(),2,0,0);
  }
  function denverTZAbbrev(isoDate){
    const d = dFromYMDLocal(isoDate);
    return isDSTDenver(d) ? 'MDT' : 'MST';
  }

  // RFC5545 TEXT unescape
  function icsUnescape(s){
    if (s == null) return s;
    return String(s)
      .replace(/\\n/gi, "\n")
      .replace(/\\N/g, "\n")
      .replace(/\\;/g, ";")
      .replace(/\\,/g, ",")
      .replace(/\\\\/g, "\\");
  }

  function unfold(text){ return text.replace(/\\r\\n/g,"\\n").replace(/\\n[ \\t]/g,""); }
  function toLocalDate(s){
    const t = String(s).trim();
    if (/^\\d{8}$/.test(t)) { return new Date(+t.slice(0,4), +t.slice(4,6)-1, +t.slice(6,8)); }
    const m = t.match(/^(\\d{4})(\\d{2})(\\d{2})T(\\d{2})(\\d{2})(\\d{2})(Z)?$/);
    if (m) {
      const Y=+m[1], Mo=+m[2], D=+m[3], h=+m[4], mi=+m[5], se=+m[6];
      return m[7] ? new Date(Date.UTC(Y,Mo-1,D,h,mi,se)) : new Date(Y,Mo-1,D,h,mi,se);
    }
    return null;
  }
  function toTimeHHMM(s){
    const m = String(s).trim().match(/^(\\d{4})(\\d{2})(\\d{2})T(\\d{2})(\\d{2})(\\d{2})(Z)?$/);
    return m ? (m[4]+":"+m[5]) : null;
  }
  function parseRRULE(s){
    const out = {};
    (s||"").split(";").forEach(pair=>{
      const [k,v] = pair.split("=",2);
      if(!k) return;
      const K=k.toUpperCase();
      if (K==='FREQ') out.freq=(v||'').toUpperCase();
      else if (K==='INTERVAL') out.interval=parseInt(v||'1',10);
      else if (K==='COUNT') out.count=parseInt(v||'0',10);
      else if (K==='UNTIL') out.until=toLocalDate(v);
      else if (K==='BYDAY') out.byDay=(v||'').split(',').map(s=>s.toUpperCase());
      else if (K==='BYMONTHDAY') out.byMonthDay=(v||'').split(',').map(x=>parseInt(x,10)).filter(n=>!isNaN(n));
    });
    return out;
  }
  function parseDateList(lines){
    const joined = lines.join('').replace(/^.*?:/,''); return joined.split(',').map(v=>toLocalDate(v)).filter(Boolean);
  }

  async function fetchICSBoth(url, tagOverride){
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error('HTTP '+res.status+' loading '+url);
    const rawText = await res.text();
    const text = unfold(rawText);

    // collect raw VEVENT blocks for combined download
    const blocksRaw = [...rawText.matchAll(/BEGIN:VEVENT[\\s\\S]*?END:VEVENT\\s*/g)].map(m=>m[0]);
    RAW_BLOCKS.push(...blocksRaw);

    const calNameMatch = text.match(/X-WR-CALNAME:(.+)/);
    const calName = calNameMatch ? calNameMatch[1].trim() : '';
    const blocks = [...text.matchAll(/BEGIN:VEVENT([\\s\\S]*?)END:VEVENT/g)].map(m=>m[1]);

    const events = [];
    for (const block of blocks){
      const lines = block.trim().split("\\n");
      const last = {}; const multi = {};
      for (const ln of lines){
        const i = ln.indexOf(":"); if (i<0) continue;
        const head = ln.slice(0,i), val = ln.slice(i+1);
        const key = head.split(";",1)[0].toUpperCase();
        (multi[key] ||= []).push(ln);
        last[key] = ln;
      }
      const getVal = k => (last[k] ? last[k].slice(last[k].indexOf(':')+1) : null);

      let summary = icsUnescape(getVal('SUMMARY')) || 'Untitled Event';
      const urlVal = icsUnescape(getVal('URL')) || null;
      let location = icsUnescape(getVal('LOCATION')) || null;

      let dtstart=null, dtend=null, allDay=false;
      if (multi['DTSTART']){
        const raw = multi['DTSTART'][0];
        allDay = /VALUE=DATE/i.test(raw) || /^\\s*DTSTART:\\d{8}\\s*$/.test(raw);
        dtstart = toLocalDate(getVal('DTSTART'));
      }
      if (multi['DTEND']){ dtend = toLocalDate(getVal('DTEND')); }
      let tStart=null, tEnd=null; if (!allDay){ tStart = toTimeHHMM(getVal('DTSTART')) || null; tEnd = toTimeHHMM(getVal('DTEND')) || null; }

      let repeat=null; if (last['RRULE']) repeat = parseRRULE(getVal('RRULE'));
      if (multi['EXDATE']) { (repeat ||= {}); repeat.exDates = parseDateList(multi['EXDATE']); }
      if (multi['RDATE'])  { (repeat ||= {}); repeat.rDates  = parseDateList(multi['RDATE']); }

      const cats = (getVal('CATEGORIES')||'').toLowerCase();
      const colr = (getVal('COLOR')||'').toLowerCase();
      let tag = tagOverride || null;
      if (!tag){
        if (cats.includes('local') || colr.includes('#32cd32') || /local/i.test(calName)) tag='local';
        else if (cats.includes('regional') || colr.includes('#ffa500') || /regional/i.test(calName)) tag='regional';
      }

      summary = summary.replace(/\\n+/g, ' ').replace(/\\s{2,}/g, ' ').trim();
      if (location) location = location.replace(/\\n+/g, ', ').replace(/\\s{2,}/g, ' ').trim();

      const ev = {
        title: summary, url: urlVal || undefined, city: location || undefined, tag,
        date:null, start:null, end:null, timeStart: tStart || undefined, timeEnd: tEnd || undefined, repeat: repeat || undefined
      };
      if (dtstart && !dtend) ev.date = ymd(dtstart);
      else if (dtstart && dtend){
        if (allDay){
          const end = new Date(dtend); end.setDate(end.getDate()-1);
          ev.start = ymd(dtstart); ev.end = ymd(end);
        } else {
          if (ymd(dtstart) === ymd(dtend)) ev.date = ymd(dtstart);
          else { ev.start = ymd(dtstart); ev.end = ymd(dtend); }
        }
      } else if (dtstart) ev.date = ymd(dtstart);

      ev._displayTitle = toTitleCase(ev.title);
      events.push(ev);
    }
    return events;
  }

  // ----------- recurrence expansion -----------
  function expandSingle(ev, monthStart, monthEnd){
    const out=[];
    if (ev.date){ const d=dFromYMDLocal(ev.date); if (within(d, monthStart, monthEnd)) out.push({...ev, _date: ev.date}); }
    else if (ev.start && ev.end){
      let d=dFromYMDLocal(ev.start), end=dFromYMDLocal(ev.end);
      while(d<=end){ if (within(d, monthStart, monthEnd)) out.push({...ev, _date: ymd(d)}); d=addDays(d,1); }
    } else if (ev.start){ const d=dFromYMDLocal(ev.start); if (within(d, monthStart, monthEnd)) out.push({...ev, _date: ev.start}); }
    return out;
  }
  function expandWeekly(ev, monthStart, monthEnd){
    const rep = ev.repeat || {};
    const interval = Math.max(1, parseInt(rep.interval || 1, 10));
    const byDay = (rep.byDay || ['MO']).map(s=>s.toUpperCase());
    const until = rep.until ? new Date(rep.until) : null;
    const ex = new Set((rep.exDates || []).map(d => ymd(d)));
    const rd = new Set((rep.rDates || []).map(d => ymd(d)));
    const windowStart = addDays(monthStart, -21);
    const windowEnd   = addDays(monthEnd, 21);
    const out = [];
    for (let anchor = new Date(windowStart); anchor <= windowEnd; anchor = addDays(anchor, 7*interval)) {
      byDay.forEach(code=>{
        const dow = DOW.indexOf(code); if (dow<0) return;
        const day = addDays(anchor, (dow - anchor.getDay() + 7) % 7);
        if (until && day > until) return;
        const iso = ymd(day);
        if ((within(day, monthStart, monthEnd) || rd.has(iso)) && !ex.has(iso)){
          out.push({...ev, _date: iso});
        }
      });
    }
    return out;
  }
  function expandDaily(ev, monthStart, monthEnd){
    const rep = ev.repeat || {};
    const interval = Math.max(1, parseInt(rep.interval || 1, 10));
    const until = rep.until ? new Date(rep.until) : null;
    const ex = new Set((rep.exDates || []).map(d => ymd(d)));
    const rd = new Set((rep.rDates || []).map(d => ymd(d)));
    let d = addDays(new Date(ev.start || ev.date), -interval*3);
    const limit = addDays(monthEnd, interval*3);
    const out=[];
    for (let guard=0; guard<5000; guard++){
      if (until && d > until) break;
      if (d > limit) break;
      const iso = ymd(d);
      if ((within(d, monthStart, monthEnd) || rd.has(iso)) && !ex.has(iso)){
        out.push({...ev, _date: iso});
      }
      d = addDays(d, interval);
    }
    return out;
  }
  function nthWeekdayOfMonth(year, month, n, dow){
    if (n>0){
      const first=new Date(year,month,1);
      const delta=(dow-first.getDay()+7)%7;
      const dateNum=1+delta+7*(n-1);
      const d=new Date(year,month,dateNum);
      return d.getMonth()===month ? d : null;
    } else {
      const last=new Date(year,month+1,0);
      const delta=(last.getDay()-dow+7)%7;
      const dateNum=last.getDate()-delta+7*(n+1);
      const d=new Date(year,month,dateNum);
      return d.getMonth()===month ? d : null;
    }
  }
  function parseNthByDayToken(tok){
    tok = tok.toUpperCase();
    const m = tok.match(/^(-?\\d+)?(SU|MO|TU|WE|TH|FR|SA)$/);
    if (!m) return null;
    const nth = m[1] ? parseInt(m[1],10) : null;
    const dow = DOW_IDX[m[2]];
    return { nth, dow };
  }
  function expandMonthly(ev, monthStart, monthEnd){
    const rep = ev.repeat || {};
    const interval = Math.max(1, parseInt(rep.interval || 1, 10));
    const until = rep.until ? new Date(rep.until) : null;
    const ex = new Set((rep.exDates || []).map(d => ymd(d)));
    const rd = new Set((rep.rDates || []).map(d => ymd(d)));
    const y = monthStart.getFullYear(), m = monthStart.getMonth();
    const monthsToTry = [-interval, 0, interval];
    const out = [];
    monthsToTry.forEach(off=>{
      const base = new Date(y, m+off, 1);
      if (until && base > until) return;
      let dates=[];
      if (Array.isArray(rep.byMonthDay) && rep.byMonthDay.length){
        rep.byMonthDay.forEach(md => {
          const d=new Date(base.getFullYear(), base.getMonth(), parseInt(md,10));
          if (d.getMonth()===base.getMonth()) dates.push(d);
        });
      } else if (Array.isArray(rep.byDay) && rep.byDay.length){
        rep.byDay.forEach(token=>{
          const p = parseNthByDayToken(token); if (!p) return;
          if (p.nth===null){
            for (let day=1; day<=31; day++){
              const d=new Date(base.getFullYear(), base.getMonth(), day);
              if (d.getMonth()!==base.getMonth()) break;
              if (d.getDay()===p.dow) dates.push(d);
            }
          } else {
            const d = nthWeekdayOfMonth(base.getFullYear(), base.getMonth(), p.nth, p.dow);
            if (d) dates.push(d);
          }
        });
      } else {
        const seed = new Date(ev.start || ev.date);
        const d = new Date(base.getFullYear(), base.getMonth(), seed.getDate());
        if (d.getMonth()===base.getMonth()) dates.push(d);
      }
      dates.forEach(d=>{
        if (until && d > until) return;
        const iso = ymd(d);
        if ((within(d, monthStart, monthEnd) || rd.has(iso)) && !ex.has(iso)){
          out.push({...ev, _date: iso});
        }
      });
    });
    return out;
  }

  function expandForMonth(raw, monthStart, monthEnd){
    const out=[];
    raw.forEach(ev=>{
      if (ev.repeat && ev.repeat.freq && (ev.start || ev.date)){
        const f=ev.repeat.freq.toUpperCase();
        if (f==='WEEKLY') out.push(...expandWeekly(ev, monthStart, monthEnd));
        else if (f==='DAILY') out.push(...expandDaily(ev, monthStart, monthEnd));
        else if (f==='MONTHLY') out.push(...expandMonthly(ev, monthStart, monthEnd));
        else out.push(...expandSingle(ev, monthStart, monthEnd));
      } else out.push(...expandSingle(ev, monthStart, monthEnd));
    });
    out.sort((a,b)=> (a._date===b._date) ? ((a.timeStart||'00:00').localeCompare(b.timeStart||'00:00')) : (a._date.localeCompare(b._date)));
    return out;
  }
  function expandForMonthRange(raw, start, end){
    const out=[];
    raw.forEach(ev=>{
      if (ev.repeat && ev.repeat.freq && (ev.start || ev.date)){
        const f=ev.repeat.freq.toUpperCase();
        if (f==='WEEKLY') out.push(...expandWeekly(ev, start, end));
        else if (f==='DAILY') out.push(...expandDaily(ev, start, end));
        else if (f==='MONTHLY') out.push(...expandMonthly(ev, start, end));
        else out.push(...expandSingle(ev, start, end));
      } else out.push(...expandSingle(ev, start, end));
    });
    out.sort((a,b)=> (a._date===b._date) ? ((a.timeStart||'00:00').localeCompare(b.timeStart||'00:00')) : (a._date.localeCompare(b._date)));
    return out;
  }

  // ----- UI interactions -----
  function activeView(){
    var el = document.querySelector('.view.pill.active');
    return (el && el.dataset && el.dataset.view) ? el.dataset.view : 'month';
  }

  document.querySelectorAll('.view.pill').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.view.pill').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const view = b.dataset.view;

      // explicit display values
      const gridEl = document.getElementById('grid');
      const agendaEl = document.getElementById('agenda');
      gridEl.style.display   = (view === 'month')  ? 'grid'  : 'none';
      agendaEl.style.display = (view === 'agenda') ? 'block' : 'none';

      if (view==='agenda') renderAgenda();
      else render();
    });
  });

  document.querySelectorAll('.filters .pill').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.filters .pill').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      FILTER = b.dataset.filter;
      activeView() === 'agenda' ? renderAgenda() : render();
    });
  });

  document.getElementById('prevMonth').addEventListener('click', ()=>{
    current.setMonth(current.getMonth()-1);
    activeView() === 'agenda' ? renderAgenda() : render();
  });
  document.getElementById('nextMonth').addEventListener('click', ()=>{
    current.setMonth(current.getMonth()+1);
    activeView() === 'agenda' ? renderAgenda() : render();
  });

  document.getElementById('subscribeCombined').addEventListener('click', ()=>{
    if (!RAW_BLOCKS.length){
      alert('Calendar is still loading. Try again in a moment.');
      return;
    }
    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Durango Tango//Combined ICS//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
` + RAW_BLOCKS.join('') + `END:VCALENDAR`;

    const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'DurangoTangoEvents.ics';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // ----- rendering -----
  function toTitleCase(s){
    if (!s) return s;
    const lower = s.toLocaleLowerCase();
    if (typeof Intl !== 'undefined' && Intl.Segmenter){
      const seg = new Intl.Segmenter(undefined, { granularity:'word' });
      let out = '';
      for (const part of seg.segment(lower)){
        if (part.isWordLike && /\\p{L}/u.test(part.segment)){
          const first = part.segment.charAt(0).toLocaleUpperCase();
          out += first + part.segment.slice(1);
        } else {
          out += part.segment;
        }
      }
      return out;
    }
    return lower.replace(/\\b(\\p{L})(\\p{L}*)/gu, (m,a,b)=> a.toLocaleUpperCase() + b);
  }

  function render(){
    const year = current.getFullYear(), month = current.getMonth();
    const first = new Date(year, month, 1);
    const last  = new Date(year, month+1, 0);
    const monthStart = new Date(year, month, 1);
    const monthEnd   = new Date(year, month, last.getDate());

    monthLabel.textContent = first.toLocaleDateString(undefined, { month:'long', year:'numeric' });

    const days = [];
    for (let d=1; d<=last.getDate(); d++) days.push(new Date(year, month, d));

    const expanded = expandForMonth(RAW, monthStart, monthEnd);
    const byDate = {};
    expanded.forEach(ev => (byDate[ev._date] ||= []).push(ev));

    grid.innerHTML = '';
    days.forEach(d=>{
      const cell = document.createElement('div'); cell.className='cell';
      const iso = ymd(d);
      const day = document.createElement('div'); day.className='day'; day.textContent = d.getDate(); cell.appendChild(day);

      const list = document.createElement('div'); list.className='events';
      const events = (byDate[iso]||[]).filter(ev=> FILTER==='all' || ev.tag===FILTER);
      if (events.length){
        const count = document.createElement('div'); count.className='count'; count.textContent = events.length; cell.appendChild(count);
      }
      events.forEach(ev=>{
        const a = document.createElement('a'); a.className='evt ' + (ev.tag||''); if (ev.url){ a.href=ev.url; a.target='_blank'; }
        const t = document.createElement('span'); t.className='t'; t.textContent = ev._displayTitle || ev.title; a.appendChild(t);
        const meta = document.createElement('span'); meta.className='tm';
        const time = ev.timeStart ? `${formatTime12(ev.timeStart)}${ev.timeEnd?'â€“'+formatTime12(ev.timeEnd):''} ${denverTZAbbrev(ev._date)}` : '';
        meta.textContent = [time, ev.city||''].filter(Boolean).join(' Â· ');
        a.appendChild(meta);
        list.appendChild(a);
      });
      cell.appendChild(list);
      grid.appendChild(cell);
    });

    notice.classList.remove('show');
    grid.setAttribute('aria-busy','false');
  }

  function renderAgenda(){
    const host = document.getElementById('agenda');
    host.innerHTML = '';
    const today = new Date(); today.setHours(0,0,0,0);
    const horizon = new Date(today); horizon.setDate(horizon.getDate()+90);

    const expanded = expandForMonthRange(RAW, today, horizon);
    const byDate = {};
    expanded.forEach(ev => (byDate[ev._date] ||= []).push(ev));

    const dates = Object.keys(byDate).sort();
    dates.forEach(iso=>{
      const group = document.createElement('div'); group.className='daygroup';
      const d = dFromYMDLocal(iso);
      const head = document.createElement('div'); head.className='dayhead';
      head.innerHTML = `<span>${d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' })}</span><span>${byDate[iso].length} event${byDate[iso].length>1?'s':''}</span>`;
      const items = document.createElement('div'); items.className='items';
      byDate[iso].forEach(ev=>{
        const row = document.createElement('div'); row.className='it';
        const dot = document.createElement('span'); dot.className='dot ' + (ev.tag||''); row.appendChild(dot);
        const info = document.createElement('div'); info.className='info';
        const t = document.createElement('div'); t.className='t'; t.textContent = ev._displayTitle || ev.title;
        const meta = document.createElement('div'); meta.className='meta';
        const time = ev.timeStart ? `${formatTime12(ev.timeStart)}${ev.timeEnd?'â€“'+formatTime12(ev.timeEnd):''} ${denverTZAbbrev(ev._date)}` : '';
        meta.textContent = [time, ev.city||''].filter(Boolean).join(' Â· ');
        info.appendChild(t); info.appendChild(meta);
        row.appendChild(info);
        if (ev.url){ const a=document.createElement('a'); a.href=ev.url; a.target='_blank'; a.textContent='Link'; a.className='btn'; a.style.padding='4px 8px'; row.appendChild(a); }
        items.appendChild(row);
      });
      group.appendChild(head); group.appendChild(items);
      host.appendChild(group);
    });
    if (!dates.length){
      host.innerHTML = '<div class="notice show">No upcoming events in the next 90 days.</div>';
    }
  }

  // ------- Structured data emitter (Events) -------
  function emitEventSchema(upcomingEvents){
    const old = document.getElementById('event-schema');
    if (old) old.remove();

    const items = upcomingEvents.slice(0, 50).map(ev => {
      const startIso = ev.timeStart
        ? new Date(ev._date + 'T' + ev.timeStart + ':00').toISOString()
        : ev._date;
      const endIso = ev.timeEnd
        ? new Date(ev._date + 'T' + ev.timeEnd + ':00').toISOString()
        : ev._date;

      return {
        "@type": "Event",
        "name": ev._displayTitle || ev.title,
        "startDate": startIso,
        "endDate": endIso,
        "eventStatus": "https://schema.org/EventScheduled",
        "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
        "location": ev.city ? {
          "@type": "Place",
          "name": ev.city,
          "address": ev.city
        } : undefined,
        "url": ev.url || "https://durangotango.info/",
        "image": ["https://durangotango.info/assets/tango-preview.jpg"],
        "description": "Argentine Tango event listed on Durango Tango."
      };
    });

    const graph = { "@context": "https://schema.org", "@graph": items };
    const tag = document.createElement('script');
    tag.type = 'application/ld+json';
    tag.id = 'event-schema';
    tag.textContent = JSON.stringify(graph);
    document.head.appendChild(tag);
  }

  // ------- Boot (load ICS, render, emit schema) -------
  (async function boot(){
    try {
      const sources = [
        { url: '/assets/Tango%20Local.ics', tag: 'local' },
        { url: '/assets/Tango%20Regional.ics', tag: 'regional' }
      ];
      RAW = []; RAW_BLOCKS = [];
      for (const s of sources){
        const part = await fetchICSBoth(s.url, s.tag);
        RAW.push(...part);
      }
      // default view
      render();

      // Emit schema for next ~90 days so Google sees Event rich data
      const today = new Date(); today.setHours(0,0,0,0);
      const horizon = new Date(today); horizon.setDate(horizon.getDate()+90);
      const expanded = expandForMonthRange(RAW, today, horizon);
      emitEventSchema(expanded);

    } catch (err) {
      console.error(err);
      notice.textContent = 'Could not load one of the .ics feeds. Make sure both exist in /assets/ and that you are serving from the site root.';
      notice.classList.add('show');
    }
  })();
  </script>
</body>
</html>
